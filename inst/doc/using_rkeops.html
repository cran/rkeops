<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Ghislain Durif" />

<meta name="date" content="2024-02-12" />

<title>Using RKeOps</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Using RKeOps</h1>
<h4 class="author">Ghislain Durif</h4>
<h4 class="date">2024-02-12</h4>


<div id="TOC">
<ul>
<li><a href="#installing-rkeops" id="toc-installing-rkeops">Installing
RKeOps</a>
<ul>
<li><a href="#requirements" id="toc-requirements">Requirements</a></li>
<li><a href="#install-from-cran" id="toc-install-from-cran">Install from
CRAN</a></li>
<li><a href="#install-development-version" id="toc-install-development-version">Install development
version</a></li>
<li><a href="#setup-and-requirement-install" id="toc-setup-and-requirement-install">Setup and requirement install</a>
<ul>
<li><a href="#note-on-python-requirement" id="toc-note-on-python-requirement">Note on Python requirement</a></li>
</ul></li>
</ul></li>
<li><a href="#how-to-use-rkeops" id="toc-how-to-use-rkeops">How to use
RKeOps</a>
<ul>
<li><a href="#lazytensors" id="toc-lazytensors">LazyTensors</a></li>
<li><a href="#generic-reductions" id="toc-generic-reductions">Generic
reductions</a>
<ul>
<li><a href="#formula" id="toc-formula">Formula</a></li>
<li><a href="#arguments" id="toc-arguments">Arguments</a></li>
<li><a href="#creating-a-new-operator" id="toc-creating-a-new-operator">Creating a new operator</a></li>
<li><a href="#run-computations" id="toc-run-computations">Run
computations</a></li>
<li><a href="#computing-gradients" id="toc-computing-gradients">Computing gradients</a></li>
</ul></li>
<li><a href="#rkeops-options" id="toc-rkeops-options">RKeOps options</a>
<ul>
<li><a href="#choosing-cpu-or-gpu-computing-at-runtime" id="toc-choosing-cpu-or-gpu-computing-at-runtime">Choosing CPU or GPU
computing at runtime</a></li>
<li><a href="#computation-precision" id="toc-computation-precision">Computation precision</a></li>
<li><a href="#verbosity" id="toc-verbosity">Verbosity</a></li>
</ul></li>
<li><a href="#data-storage-orientation" id="toc-data-storage-orientation">Data storage orientation</a>
<ul>
<li><a href="#compilation-files-and-cleaning" id="toc-compilation-files-and-cleaning">Compilation files and
cleaning</a></li>
</ul></li>
</ul></li>
</ul>
</div>

<p>RKeOps is a R front-end for the KeOps C++/Cuda library. It provides
standard functions that can be used in any R code.<br><br></p>
<p>Thanks to RKeOps, you can use <strong>GPU computing directly inside
R</strong> without the cost of developing a specific CUDA implementation
of your custom mathematical operators.</p>
<div id="installing-rkeops" class="section level1">
<h1>Installing RKeOps</h1>
<div id="requirements" class="section level2">
<h2>Requirements</h2>
<ul>
<li>R (tested with R &gt;= 4.2)</li>
<li>C++ compiler (g++ &gt;=7 or clang) for CPU computing or CUDA
compiler (nvcc &gt;=10) and CUDA libs for GPU computing</li>
<li>Python (&gt;= 3.10)</li>
</ul>
<p><strong>Important:</strong> Python is a requirement as an intern
machinery for the package to work but you will not need to create nor
manipulate Python codes to use the RKeOps package.</p>
<p><strong>Disclaimer:</strong> KeOps (including RKeOps) is not
functional on Windows, it was only tested on Linux and MacOS.</p>
</div>
<div id="install-from-cran" class="section level2">
<h2>Install from CRAN</h2>
<blockquote>
<p><strong>Note:</strong> RKeOps is avaible on CRAN but only for UNIX
environment (GNU/Linux and MacOS) and not for Windows.</p>
</blockquote>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;rkeops&quot;</span>)</span></code></pre></div>
<!-- RKeOps >=2 is not available on CRAN yet, please refer to the next section. -->
</div>
<div id="install-development-version" class="section level2">
<h2>Install development version</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;remotes&quot;</span>)</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;getkeops/keops&quot;</span>, <span class="at">subdir =</span> <span class="st">&quot;rkeops&quot;</span>)</span></code></pre></div>
</div>
<div id="setup-and-requirement-install" class="section level2">
<h2>Setup and requirement install</h2>
<p><strong>To be done once after installation:</strong></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># load rkeops</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="fu">library</span>(rkeops)</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="co"># create a dedicated Python environment with reticulate (to be done only once)</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>reticulate<span class="sc">::</span><span class="fu">virtualenv_create</span>(<span class="st">&quot;rkeops&quot;</span>)</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="co"># activate the dedicated Python environment</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>reticulate<span class="sc">::</span><span class="fu">use_virtualenv</span>(<span class="at">virtualenv =</span> <span class="st">&quot;rkeops&quot;</span>, <span class="at">required =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="co"># install rkeops requirements (to be done only once)</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="fu">install_rkeops</span>()</span></code></pre></div>
<div id="note-on-python-requirement" class="section level3">
<h3>Note on Python requirement</h3>
<p>RKeOps now uses PyKeOps Python package under the hood thanks to the
<a href="https://rstudio.github.io/reticulate/"><code>reticulate</code></a>
R package that provides an “R Interface to Python”.</p>
<p>We recommend to use a dedicated Python environment (through
<code>reticulate</code>) to install and use RKeOps Python dependencies
(c.f. <a href="#setup-and-requirement-install">previously</a>).</p>
<blockquote>
<p><strong>Note:</strong> To get more information about
<strong>managing</strong> which <strong>version of Python</strong> you
are using, you can refer to <code>reticulate</code> <a href="https://rstudio.github.io/reticulate/articles/versions.html">documentation</a>
about “Python Version Configuration”. In particular, if you are a
Miniconda/Anaconda Python distribution user, you can either user a
Python virtual environment (c.f. above) or a <strong>Conda
environment</strong> with the same results. Please refer to the
<code>reticulate</code> <a href="https://rstudio.github.io/reticulate/articles/versions.html#providing-hints">documentation</a>
in this case.</p>
</blockquote>
<hr />
</div>
</div>
</div>
<div id="how-to-use-rkeops" class="section level1">
<h1>How to use RKeOps</h1>
<p>Load RKeOps in R:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># load rkeops</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="fu">library</span>(rkeops)</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="co"># activate the dedicated Python environment</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>reticulate<span class="sc">::</span><span class="fu">use_virtualenv</span>(<span class="at">virtualenv =</span> <span class="st">&quot;rkeops&quot;</span>, <span class="at">required =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p><strong>Note</strong>: If you are using a Python environment (c.f. <a href="#note-on-python-requirement">previously</a>), you should always
activate it after loading RKeOps.</p>
<p>You can verify that every thing is ok:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">check_rkeops</span>()</span></code></pre></div>
<p>RKeOps allows to define and compile new operators that run
computations on GPU.</p>
<div id="lazytensors" class="section level2">
<h2>LazyTensors</h2>
<p>Lazy evaluation allows to write intermediate computations as symbolic
operations that are not directly evaluated. The real evaluation is only
made on final computation.</p>
<p>To do so, you can use <code>LazyTensors</code>. These are objects
wrapped around R matrices or vectors used to create symbolic formulas
for the <code>KeOps</code> reduction operations. A typical use case is
the following:</p>
<p>Let us say that we want to compute (for all <span class="math inline">\(j=1,\dots,N\)</span>):</p>
<p><span class="math display">\[
a_j = \sum_{i=1}^{M} \exp\left(-\frac{\Vert \mathbf x_i - \mathbf
y_j\Vert^2}{s^2}\right)
\]</span></p>
<p>with</p>
<ul>
<li><p>parameter: <span class="math inline">\(s \in\mathbb
R\)</span><br></p></li>
<li><p><span class="math inline">\(i\)</span>-indexed variables <span class="math inline">\(\mathbf X = [\mathbf x_i]_{i=1,...,M} \in\mathbb
R^{M\times 3}\)</span><br></p></li>
<li><p><span class="math inline">\(j\)</span>-indexed variables <span class="math inline">\(\mathbf Y = [\mathbf y_j]_{j=1,...,N} \in\mathbb
R^{N\times 3}\)</span><br><br></p></li>
</ul>
<p>The associated code would be:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># to run computation on CPU (default mode)</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="fu">rkeops_use_cpu</span>()</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="co"># OR</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="co"># to run computations on GPU (to be used only if relevant)</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="fu">rkeops_use_gpu</span>()</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="co"># Data</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>M <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">15000</span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(N <span class="sc">*</span> <span class="dv">3</span>), <span class="at">nrow =</span> M, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="co"># arbitrary R matrix representing </span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>                                              <span class="co"># 10000 data points in R^3</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(M <span class="sc">*</span> <span class="dv">3</span>), <span class="at">nrow =</span> N, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="co"># arbitrary R matrix representing </span></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>                                              <span class="co"># 15000 data points in R^3</span></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fl">0.1</span>                                      <span class="co"># scale parameter</span></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a><span class="co"># Turn our Tensors into KeOps symbolic variables:</span></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a>x_i <span class="ot">&lt;-</span> <span class="fu">LazyTensor</span>(x, <span class="st">&quot;i&quot;</span>)     <span class="co"># symbolic object representing an arbitrary row of x, </span></span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>                              <span class="co"># indexed by the letter &quot;i&quot;</span></span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a>y_j <span class="ot">&lt;-</span> <span class="fu">LazyTensor</span>(y, <span class="st">&quot;j&quot;</span>)     <span class="co"># symbolic object representing an arbitrary row of y, </span></span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a>                              <span class="co"># indexed by the letter &quot;j&quot;</span></span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a></span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a><span class="co"># Perform large-scale computations, without memory overflows:</span></span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a>D_ij <span class="ot">&lt;-</span> <span class="fu">sum</span>((x_i <span class="sc">-</span> y_j)<span class="sc">^</span><span class="dv">2</span>)    <span class="co"># symbolic matrix of pairwise squared distances, </span></span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a>                              <span class="co"># with 10000 rows and 15000 columns</span></span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a>K_ij <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span> D_ij <span class="sc">/</span> s<span class="sc">^</span><span class="dv">2</span>)     <span class="co"># symbolic matrix, 10000 rows and 15000 columns</span></span>
<span id="cb6-27"><a href="#cb6-27" tabindex="-1"></a></span>
<span id="cb6-28"><a href="#cb6-28" tabindex="-1"></a><span class="co"># D_ij and K_ij are only symbolic at that point, no computation is done</span></span>
<span id="cb6-29"><a href="#cb6-29" tabindex="-1"></a></span>
<span id="cb6-30"><a href="#cb6-30" tabindex="-1"></a><span class="co"># Computing the result without storing D_ij and K_ij:</span></span>
<span id="cb6-31"><a href="#cb6-31" tabindex="-1"></a>a_j <span class="ot">&lt;-</span> <span class="fu">sum</span>(K_ij, <span class="at">index =</span> <span class="st">&quot;i&quot;</span>) <span class="co"># actual R matrix (in fact a row vector of </span></span>
<span id="cb6-32"><a href="#cb6-32" tabindex="-1"></a>                              <span class="co"># length 15000 here)</span></span>
<span id="cb6-33"><a href="#cb6-33" tabindex="-1"></a>                              <span class="co"># containing the column sums of K_ij</span></span>
<span id="cb6-34"><a href="#cb6-34" tabindex="-1"></a>                              <span class="co"># (i.e. the sums over the &quot;i&quot; index, for each </span></span>
<span id="cb6-35"><a href="#cb6-35" tabindex="-1"></a>                              <span class="co"># &quot;j&quot; index)</span></span></code></pre></div>
<p><strong>More in the dedicated “RKeOps LazyTensor” <a href="https://www.kernel-operations.io/rkeops/articles/LazyTensor_rkeops.html">article</a></strong>
or in the corresponding vignette:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">vignette</span>(<span class="st">&quot;LazyTensor_rkeops&quot;</span>, <span class="at">package =</span> <span class="st">&quot;rkeops&quot;</span>)</span></code></pre></div>
</div>
<div id="generic-reductions" class="section level2">
<h2>Generic reductions</h2>
<p>With RKeOps, you can also directly define new operator with plain
mathematical formula written as a character string:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="co"># implementation of a convolution with a Gaussian kernel</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>formula <span class="ot">=</span> <span class="st">&quot;Sum_Reduction(Exp(-s * SqNorm2(x - y)) * b, 0)&quot;</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="co"># input arguments</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>args <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;x = Vi(3)&quot;</span>,      <span class="co"># vector indexed by i (of dim 3)</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>         <span class="st">&quot;y = Vj(3)&quot;</span>,      <span class="co"># vector indexed by j (of dim 3)</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>         <span class="st">&quot;b = Vj(6)&quot;</span>,      <span class="co"># vector indexed by j (of dim 6)</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>         <span class="st">&quot;s = Pm(1)&quot;</span>)      <span class="co"># parameter (scalar)</span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a><span class="co"># compilation</span></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>op <span class="ot">&lt;-</span> <span class="fu">keops_kernel</span>(formula, args)</span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a><span class="co"># data and parameter values</span></span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>nx <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>ny <span class="ot">&lt;-</span> <span class="dv">150</span></span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(nx<span class="sc">*</span><span class="dv">3</span>), <span class="at">nrow=</span>nx)   <span class="co"># matrix 100 x 3</span></span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(ny<span class="sc">*</span><span class="dv">3</span>), <span class="at">nrow=</span>ny)   <span class="co"># matrix 150 x 3</span></span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(ny<span class="sc">*</span><span class="dv">6</span>), <span class="at">nrow=</span>ny)   <span class="co"># matrix 150 x 6</span></span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a><span class="co"># to run computation on CPU (default mode)</span></span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a><span class="fu">use_cpu</span>()</span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a><span class="co"># to run computations on GPU (to be used only if relevant)</span></span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a><span class="fu">use_gpu</span>()</span>
<span id="cb8-22"><a href="#cb8-22" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" tabindex="-1"></a><span class="co"># computation (order of the input arguments should be similar to `args`)</span></span>
<span id="cb8-24"><a href="#cb8-24" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">op</span>(<span class="fu">list</span>(X, Y, B, s))</span></code></pre></div>
<p>The different elements (formula, arguments, compilation, computation)
in the previous example will be detailed in the next sections.</p>
<div id="formula" class="section level3">
<h3>Formula</h3>
<p>To use RKeOps and define new operators, you need to write the
corresponding <em>formula</em> which is a text string defining a
composition of mathematical operations. It should be characterized by
two elements:</p>
<ol style="list-style-type: decimal">
<li><p>a composition of generic functions applied to some input
matrices, whose one of their dimensions is either indexed by <span class="math inline">\(i=1,...,M\)</span> or <span class="math inline">\(j=1,...,N\)</span></p></li>
<li><p>a reduction over indexes <span class="math inline">\(i=1,...,M\)</span> (row-wise) or <span class="math inline">\(j=1,...,N\)</span> (column-wise) of the <span class="math inline">\(M \times N\)</span> matrix whose entries are
defined by 1.</p></li>
</ol>
<p>RKeOps implements a wide range of mathematical operators and
reduction: please refers to <a href="https://www.kernel-operations.io/keops/api/math-operations.html" class="uri">https://www.kernel-operations.io/keops/api/math-operations.html</a>
for more details.<br><br></p>
<p><strong>Example:</strong> We want to implement the following
kernel-based reduction (convolution with a Gaussian kernel): <span class="math display">\[\sum_{j=1}^{N} \exp\Big(-\sigma || \mathbf x_i -
\mathbf y_j ||_2^{\,2}\Big)\,\mathbf b_j\]</span> with</p>
<ul>
<li><p>parameter: <span class="math inline">\(\sigma\in\mathbb
R\)</span><br></p></li>
<li><p><span class="math inline">\(i\)</span>-indexed variables <span class="math inline">\([\mathbf x_i]_{i=1,...,M} \in\mathbb R^{M\times
3}\)</span><br></p></li>
<li><p><span class="math inline">\(j\)</span>-indexed variables <span class="math inline">\([\mathbf y_j]_{j=1,...,N} \in\mathbb R^{N\times
3}\)</span> and <span class="math inline">\([\mathbf b_j]_{j=1,...,N}
\in\mathbb R^{N\times 6}\)</span><br><br></p></li>
</ul>
<p>In R, we can define the corresponding KeOps formula as a simple
<strong>text string</strong>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>formula <span class="ot">=</span> <span class="st">&quot;Sum_Reduction(Exp(-s * SqNorm2(x - y)) * b, 0)&quot;</span></span></code></pre></div>
<ul>
<li><code>SqNorm2</code> = squared <span class="math inline">\(\ell_2\)</span> norm</li>
<li><code>Exp</code> = exponential</li>
<li><code>Sum_reduction(..., 0)</code> = sum reduction over the
dimension 0 i.e. sum on the <span class="math inline">\(j\)</span>’s (1
to sum over the <span class="math inline">\(i\)</span>’s)<br></li>
</ul>
</div>
<div id="arguments" class="section level3">
<h3>Arguments</h3>
<p>The formula describing your computation can take several input
arguments: variables and parameters. The input variables will generally
corresponds to rows or columns of your data matrices, you need to be
cautious with their dimensions.</p>
<div id="input-matrix" class="section level4">
<h4>Input matrix</h4>
<p>You can use two type of input matrices with RKeOps:<br></p>
<ul>
<li><p>ones whose rows (or columns) are indexed by <span class="math inline">\(i=1,...,M\)</span> such as <span class="math inline">\(\mathbf X = [x_{ik}]_{M \times
D}\)</span><br></p></li>
<li><p>others whose rows (or columns) are indexed by <span class="math inline">\(j=1,...,N\)</span> such as <span class="math inline">\(\mathbf Y = [y_{ik&#39;}]_{N \times
D&#39;}\)</span><br><br></p></li>
</ul>
<p>The dimensions over indexes <span class="math inline">\(i\)</span> or
<span class="math inline">\(j\)</span> are called the <strong>outer
dimensions</strong> (i.e. <span class="math inline">\(M\)</span> or
<span class="math inline">\(N\)</span>). The other dimensions
(i.e. <span class="math inline">\(D\)</span> or <span class="math inline">\(D&#39;\)</span>) are called the <strong>inner
dimensions</strong>. These terms refer to the contiguity of the data in
memory:<br></p>
<ul>
<li><p><strong>Outer dimensions</strong> <span class="math inline">\(M\)</span> and <span class="math inline">\(N\)</span> (over indexes <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> respectively) can be <strong>very
large</strong>, even too large for GPU memory.<br></p></li>
<li><p><strong>Inner dimensions</strong> <span class="math inline">\(D\)</span> and <span class="math inline">\(D&#39;\)</span> should be <strong>small</strong>
enough to fit in GPU memory, in particular to ensure data colocality and
avoid useless memory transfers. Corresponding columns (or rows) should
be contiguous in memory (this point is handled for you in RKeOps, see
this <a href="#data-storage-orientation">section</a>).<br></p></li>
</ul>
<blockquote>
<p><strong>Note 1:</strong> The outer dimension can correspond to the
rows or the columns of the input matrices (and vice-versa for the inner
dimension). The optimal orientation of input matrices is discussed in
this <a href="#data-storage-orientation">section</a> .</p>
</blockquote>
<blockquote>
<p><strong><em>Note 2:</em></strong> All matrices indexed by <span class="math inline">\(i\)</span> should have the same outer dimension
<span class="math inline">\(M\)</span> over <span class="math inline">\(i\)</span>, same for all matrices indexed by <span class="math inline">\(j\)</span> (outer dimension <span class="math inline">\(N\)</span>). <strong>Only the inner dimensions
<span class="math inline">\(D\)</span> and <span class="math inline">\(D&#39;\)</span> should be known for the
compilation of your operators.</strong> The respective outer dimensions
<span class="math inline">\(M\)</span> and <span class="math inline">\(N\)</span> are discovered at runtime (and can
change from one run to another).<br></p>
</blockquote>
</div>
<div id="notations" class="section level4">
<h4>Notations</h4>
<p>Input arguments of the formula are defined by using keywords, they
can be of different types:</p>
<table>
<thead>
<tr class="header">
<th align="left">keyword</th>
<th align="left">meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code>Vi</code></td>
<td align="left">variable indexed by <code>i</code></td>
</tr>
<tr class="even">
<td align="left"><code>Vj</code></td>
<td align="left">variable indexed by <code>j</code></td>
</tr>
<tr class="odd">
<td align="left"><code>Pm</code></td>
<td align="left">parameter</td>
</tr>
</tbody>
</table>
<p>You should provide a vector of text string specifying the name and
the type of all arguments in your formula.</p>
<p>Each keyword takes as parameter the inner dimension of the
corresponding object. For instance, to define an input variable indexed
by <span class="math inline">\(i\)</span> corresponding to a <span class="math inline">\(D\)</span>-dimensional vector, you can use
<code>&quot;Vi(D)&quot;</code>, same for a <span class="math inline">\(D\)</span>-dimensional variable indexed by <span class="math inline">\(j\)</span> being <code>&quot;Vj(D)&quot;</code> or a <span class="math inline">\(D\)</span>-dimensional parameter
<code>&quot;Pm(D)&quot;</code>.<br><br></p>
<p>The vector of arguments should be</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>args <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;&lt;name1&gt;=&lt;type1&gt;(dim1)&quot;</span>, <span class="st">&quot;&lt;name2&gt;=&lt;type2&gt;(dim2)&quot;</span>, <span class="st">&quot;&lt;nameX&gt;=&lt;typeX&gt;(dimX)&quot;</span>)</span></code></pre></div>
<p>where</p>
<ul>
<li><code>&lt;nameX&gt;</code> is the name</li>
<li><code>&lt;type1&gt;</code> is the type (among <code>Vi</code>,
<code>Vj</code> or <code>Pm</code>)</li>
<li><code>&lt;dimX&gt;</code> is the <strong>inner
dimension</strong></li>
</ul>
<p>of the <code>X</code><span class="math inline">\(^\text{th}\)</span>
variable in the formula.<br><br></p>
<blockquote>
<p><strong>Important:</strong> The names should correspond to the ones
used in the formula. The input parameter order will be the one used when
calling the compiled operator.</p>
</blockquote>
<p><strong>Example:</strong> We define the corresponding arguments of
the previous <a href="#formula">formula</a>, i.e. parameters or
variables indexed by <span class="math inline">\(i\)</span> or <span class="math inline">\(j\)</span> with their corresponding inner
dimensions:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>args <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;x = Vi(3)&quot;</span>,      <span class="co"># vector indexed by i (of dim 3)</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>         <span class="st">&quot;y = Vj(3)&quot;</span>,      <span class="co"># vector indexed by j (of dim 3)</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>         <span class="st">&quot;b = Vj(6)&quot;</span>,      <span class="co"># vector indexed by j (of dim 6)</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>         <span class="st">&quot;s = Pm(1)&quot;</span>)      <span class="co"># parameter (scalar)</span></span></code></pre></div>
</div>
</div>
<div id="creating-a-new-operator" class="section level3">
<h3>Creating a new operator</h3>
<p>By using the function <code>keops_kernel</code>, based on the formula
and its arguments that we previously defined, we can compile and load
into R the corresponding operator:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="co"># compilation</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>op <span class="ot">&lt;-</span> <span class="fu">keops_kernel</span>(formula, args)</span></code></pre></div>
<p>Calling <code>keops_kernel(formula, args)</code> returns a function
that can be later used to run computations on your data with your value
of parameters. You should only be cautious with the similarity of each
argument inner dimension.<br><br></p>
<p>The returned function (here <code>op</code>) expects a list of input
values in the order specified in the vector <code>args</code>.</p>
<p>The result of compilation (shared library file) is stored on the
system and will be reused when calling again the function
<code>keops_kernel</code> on the same formula with the same arguments
and the same conditions (e.g. precision), to avoid useless
recompilation.</p>
</div>
<div id="run-computations" class="section level3">
<h3>Run computations</h3>
<p>We generate data with inner dimensions (number of columns)
corresponding to each arguments expected by the operator
<code>op</code>. The function <code>op</code> takes in input a list of
input arguments. If the list if named, <code>op</code> checks the
association between the supplied names and the names of the formula
arguments. In this case only, it can also correct the order of the input
list to match the expected order of arguments.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co"># data and parameter values</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>nx <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>ny <span class="ot">&lt;-</span> <span class="dv">150</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(nx<span class="sc">*</span><span class="dv">3</span>), <span class="at">nrow=</span>nx)   <span class="co"># matrix 100 x 3</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(ny<span class="sc">*</span><span class="dv">3</span>), <span class="at">nrow=</span>ny)   <span class="co"># matrix 150 x 3</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(ny<span class="sc">*</span><span class="dv">6</span>), <span class="at">nrow=</span>ny)   <span class="co"># matrix 150 x 6</span></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a><span class="co"># to run computation on CPU (default mode)</span></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a><span class="fu">rkeops_use_cpu</span>()</span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a><span class="co"># OR</span></span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a><span class="co"># to run computations on GPU (to be used only if relevant)</span></span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a><span class="fu">rkeops_use_gpu</span>()</span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a><span class="co"># computation (order of the input arguments should be similar to `args`)</span></span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">op</span>(<span class="fu">list</span>(x, y, beta, s))</span></code></pre></div>
</div>
<div id="computing-gradients" class="section level3">
<h3>Computing gradients</h3>
<p>You can define gradients directly in the formula, e.g.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="co"># defining a formula with a Gradient</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>formula <span class="ot">&lt;-</span> <span class="st">&quot;Grad(Sum_Reduction(SqNorm2(x-y), 0), x, eta)&quot;</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>args <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;x=Vi(0,3)&quot;</span>, <span class="st">&quot;y=Vj(1,3)&quot;</span>, <span class="st">&quot;eta=Vi(2,1)&quot;</span>)</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a><span class="co"># compiling the corresponding operator</span></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>op <span class="ot">&lt;-</span> <span class="fu">keops_kernel</span>(formula, args)</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a><span class="co"># data</span></span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>nx <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>ny <span class="ot">&lt;-</span> <span class="dv">150</span></span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(nx<span class="sc">*</span><span class="dv">3</span>), <span class="at">nrow=</span>nx, <span class="at">ncol=</span><span class="dv">3</span>)     <span class="co"># matrix 100 x 3</span></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(ny<span class="sc">*</span><span class="dv">3</span>), <span class="at">nrow=</span>ny, <span class="at">ncol=</span><span class="dv">3</span>)     <span class="co"># matrix 150 x 3</span></span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a>eta <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(nx<span class="sc">*</span><span class="dv">1</span>), <span class="at">nrow=</span>nx, <span class="at">ncol=</span><span class="dv">1</span>)   <span class="co"># matrix 100 x 1</span></span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a><span class="co"># computation</span></span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a>input <span class="ot">&lt;-</span> <span class="fu">list</span>(x, y, eta)</span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">op</span>(input)</span></code></pre></div>
<p>where <code>eta</code> is the new variable at which the gradient is
computed, its dimension should correspond to the output dimension of the
operation inside the gradient (here <code>SqNorm2(x-y)</code> is of
dimension 1).</p>
<p>You can also use the function <code>keops_grad</code> to compute
partial derivative for existing KeOps operators.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="co"># defining an operator (reduction on squared distance)</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>formula <span class="ot">&lt;-</span> <span class="st">&quot;Sum_Reduction(SqNorm2(x-y), 0)&quot;</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>args <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;x=Vi(0,3)&quot;</span>, <span class="st">&quot;y=Vj(1,3)&quot;</span>)</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>op <span class="ot">&lt;-</span> <span class="fu">keops_kernel</span>(formula, args)</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="co"># defining its gradient regarding x</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>grad_op <span class="ot">&lt;-</span> <span class="fu">keops_grad</span>(op, <span class="at">var=</span><span class="st">&quot;x&quot;</span>)</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a><span class="co"># data</span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>nx <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>ny <span class="ot">&lt;-</span> <span class="dv">150</span></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(nx<span class="sc">*</span><span class="dv">3</span>), <span class="at">nrow=</span>nx, <span class="at">ncol=</span><span class="dv">3</span>)     <span class="co"># matrix 100 x 3</span></span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(ny<span class="sc">*</span><span class="dv">3</span>), <span class="at">nrow=</span>ny, <span class="at">ncol=</span><span class="dv">3</span>)     <span class="co"># matrix 150 x 3</span></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>eta <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(nx<span class="sc">*</span><span class="dv">1</span>), <span class="at">nrow=</span>nx, <span class="at">ncol=</span><span class="dv">1</span>)   <span class="co"># matrix 100 x 1</span></span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a><span class="co"># computation</span></span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a>input <span class="ot">&lt;-</span> <span class="fu">list</span>(x, y, eta)</span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">grad_op</span>(input)</span></code></pre></div>
<p><strong>Note:</strong> when defining a gradient, the operator created
by <code>keops_grad</code>requires an additional variable, of the same
type (<code>Vi</code>, <code>Vj</code>, <code>Pm</code>) as the variable
with respect to which the differentiation is made (here <code>x</code>
hence <code>Vi</code>), and whose inner dimension corresponds to the
output dimension of the derived formula (here <code>SqNorm2(x-y)</code>
is a real-valued function, hence dimension 1). In addition, (if
<code>Vi</code>, <code>Vj</code> variable), its outer dimension should
corresponds to the outer dimension of the variable regarding which the
gradient is taken (here <code>x</code>).</p>
</div>
</div>
<div id="rkeops-options" class="section level2">
<h2>RKeOps options</h2>
<p>RKeOps behavior is driven by specific options in <code>R</code>
global options scope. Such options are set up when loading RKeOps
(i.e. by calling <code>library(rkeops)</code>).</p>
<p>You can get the current values of RKeOps options with</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="fu">get_rkeops_options</span>()</span></code></pre></div>
<p>To (re)set RKeOps options to default values, run:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="fu">set_rkeops_options</span>()</span></code></pre></div>
<p>You can either use <code>set_rkeops_options()</code> to modify a
specific options (c.f. <code>?set_rkeops_options</code>) or you can use
helper functions, c.f. below.</p>
<div id="choosing-cpu-or-gpu-computing-at-runtime" class="section level3">
<h3>Choosing CPU or GPU computing at runtime</h3>
<p>By default, RKeOps runs computations on CPU (even for GPU-compiled
operators). To enable GPU computing, you can run (before calling your
operator):</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="fu">rkeops_use_gpu</span>()</span></code></pre></div>
<p>You can also specify the GPU id that you want to use,
e.g. <code>rkeops_use_gpu(device=0)</code> to use GPU 0 (default) for
instance.</p>
<p>To deactivate GPU computations, you can run
<code>rkeops_use_cpu()</code>.</p>
<blockquote>
<p>In CPU mode, you can control the number of CPU cores used by RKeOps
for computations, e.g. with <code>rkeops_use_cpu(ncore = 2)</code> to
run on 2 cores.</p>
</blockquote>
</div>
<div id="computation-precision" class="section level3">
<h3>Computation precision</h3>
<p>By default, RKeOps uses 32bits float precision for computations.
Since R only considers 64bits floating point numbers, if you want to use
float 32bits, input data and output results will be casted befors and
after computations respectively in your RKeOps operator. If your
application requires to use 64bits float (double) precision, keep in
mind that you will suffer a performance loss (potentially not an issue
on high-end GPUs). In any case, compensated summation reduction is
available in KeOps to correct for 32bits floating point arithmetic
errors (see <code>sum_scheme</code> argument for
<code>keops_kernel()</code> function, c.f.
<code>?keops_kernel</code>).</p>
<p>You use the following functions to choose between 32bits float and
64bits float precision (respectively):</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="fu">rkeops_use_float32</span>()</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a><span class="fu">rkeops_use_float64</span>()</span></code></pre></div>
</div>
<div id="verbosity" class="section level3">
<h3>Verbosity</h3>
<p>You can use the following functions to respectively enable and
disable compilation verbosity:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="fu">rkeops_enable_verbosity</span>()</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="fu">rkeops_disable_verbosity</span>()</span></code></pre></div>
</div>
</div>
<div id="data-storage-orientation" class="section level2">
<h2>Data storage orientation</h2>
<p>In R, matrices are stored using a column-major order, meaning that a
<span class="math inline">\(M \times D\)</span> matrix is stored in
memory as a succession of <span class="math inline">\(D\)</span> vectors
of length <span class="math inline">\(M\)</span> representing each of
its columns. A consequence is that two successive entries of a column
are contiguous in memory, but two successive entries of a row are
separated by <span class="math inline">\(M\)</span> elements. See this
<a href="https://en.wikipedia.org/wiki/Row-_and_column-major_order">page</a>
for more details.<br><br></p>
<p><strong><em>Important:</em></strong> In machine learning and
statistics, we generally use data matrices where each
sample/observation/individual is a row, i.e. matrices where the outer
dimensions correspond to rows, e.g. <span class="math inline">\(\mathbf
X = [x_{ik}]_{M \times D}\)</span>, <span class="math inline">\(\mathbf
Y = [y_{ik&#39;}]_{N \times D&#39;}\)</span>. This is the default using
case of RKeOps. RKeOps will then automatically process the input data to
enforce colocality along the inner dimension.</p>
<p>If you want to use data where the inner dimension corresponds to rows
of your matrices, i.e. <span class="math inline">\(\mathbf X^{t} =
[x_{ki}]_{D \times M}\)</span> or <span class="math inline">\(\mathbf
Y^{t} = [y_{k&#39;i}]_{D&#39; \times N}\)</span>, you just need to
specify the input parameter <code>inner_dim=&quot;row&quot;</code> when calling
your operator.</p>
<p>Example:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="co"># standard column reduction of a matrix product</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>op <span class="ot">&lt;-</span> <span class="fu">keops_kernel</span>(<span class="at">formula =</span> <span class="st">&quot;Sum_Reduction((x|y), 1)&quot;</span>,</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>                   <span class="at">args =</span> <span class="fu">c</span>(<span class="st">&quot;x=Vi(3)&quot;</span>, <span class="st">&quot;y=Vj(3)&quot;</span>))</span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a><span class="co"># data (inner dimension = columns)</span></span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a>nx <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a>ny <span class="ot">&lt;-</span> <span class="dv">15</span></span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a><span class="co"># x_i = rows of the matrix X</span></span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(nx<span class="sc">*</span><span class="dv">3</span>), <span class="at">nrow=</span>nx, <span class="at">ncol=</span><span class="dv">3</span>)</span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a><span class="co"># y_j = rows of the matrix Y</span></span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(ny<span class="sc">*</span><span class="dv">3</span>), <span class="at">nrow=</span>ny, <span class="at">ncol=</span><span class="dv">3</span>)</span>
<span id="cb21-12"><a href="#cb21-12" tabindex="-1"></a><span class="co"># computing the result (here, by default `inner_dim=&quot;col&quot;` and columns </span></span>
<span id="cb21-13"><a href="#cb21-13" tabindex="-1"></a><span class="co"># corresponds to the inner dimension)</span></span>
<span id="cb21-14"><a href="#cb21-14" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">op</span>(<span class="fu">list</span>(X,Y))</span>
<span id="cb21-15"><a href="#cb21-15" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" tabindex="-1"></a><span class="co"># data (inner dimension = rows)</span></span>
<span id="cb21-17"><a href="#cb21-17" tabindex="-1"></a>nx <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb21-18"><a href="#cb21-18" tabindex="-1"></a>ny <span class="ot">&lt;-</span> <span class="dv">15</span></span>
<span id="cb21-19"><a href="#cb21-19" tabindex="-1"></a><span class="co"># x_i = columns of the matrix X</span></span>
<span id="cb21-20"><a href="#cb21-20" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(nx<span class="sc">*</span><span class="dv">3</span>), <span class="at">nrow=</span><span class="dv">3</span>, <span class="at">ncol=</span>nx)</span>
<span id="cb21-21"><a href="#cb21-21" tabindex="-1"></a><span class="co"># y_j = columns of the matrix Y</span></span>
<span id="cb21-22"><a href="#cb21-22" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(ny<span class="sc">*</span><span class="dv">3</span>), <span class="at">nrow=</span><span class="dv">3</span>, <span class="at">ncol=</span>ny)</span>
<span id="cb21-23"><a href="#cb21-23" tabindex="-1"></a><span class="co"># computing the result (we specify `inner_dim=&quot;row&quot;` to indicate that rows</span></span>
<span id="cb21-24"><a href="#cb21-24" tabindex="-1"></a><span class="co"># corresponds to the inner dimension)</span></span>
<span id="cb21-25"><a href="#cb21-25" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">op</span>(<span class="fu">list</span>(X,Y), <span class="at">inner_dim=</span><span class="st">&quot;row&quot;</span>)</span></code></pre></div>
<div id="compilation-files-and-cleaning" class="section level3">
<h3>Compilation files and cleaning</h3>
<p>The compilation of new operators produces shared library (or share
object <code>.so</code>) files stored in a <code>build</code>
sub-directory of the package installation directory, to be reused and
avoid recompilation of already defined operators.</p>
<p>You can check where your compiled operators are stored by running
<code>get_rkeops_build_dir()</code>. To clean RKeOps install and remove
all shared library files, you can run <code>clean_rkeops()</code>.</p>
</div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
