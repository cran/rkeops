<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Amelie Vernay" />
<meta name="author" content="Chloe Serre-Combe" />
<meta name="author" content="Ghislain Durif" />

<meta name="date" content="2024-02-12" />

<title>RKeOps LazyTensor</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">RKeOps LazyTensor</h1>
<h4 class="author">Amelie Vernay</h4>
<h4 class="author">Chloe Serre-Combe</h4>
<h4 class="author">Ghislain Durif</h4>
<h4 class="date">2024-02-12</h4>


<div id="TOC">
<ul>
<li><a href="#setup" id="toc-setup">Setup</a></li>
<li><a href="#lazy-evaluation" id="toc-lazy-evaluation">Lazy
evaluation</a></li>
<li><a href="#lazytensor" id="toc-lazytensor">LazyTensor</a>
<ul>
<li><a href="#complexlazytensor" id="toc-complexlazytensor">ComplexLazyTensor</a></li>
</ul></li>
<li><a href="#operations" id="toc-operations">Operations</a>
<ul>
<li><a href="#result-dimension" id="toc-result-dimension">Result
dimension</a></li>
<li><a href="#simple-arithmetics" id="toc-simple-arithmetics">Simple
arithmetics</a></li>
<li><a href="#elementary-functions" id="toc-elementary-functions">Elementary functions</a></li>
<li><a href="#operations-involving-complex-numbers" id="toc-operations-involving-complex-numbers">Operations involving
complex numbers</a></li>
<li><a href="#simple-vector-operations" id="toc-simple-vector-operations">Simple vector operations</a></li>
<li><a href="#elementary-dot-products" id="toc-elementary-dot-products">Elementary dot products</a></li>
<li><a href="#constants-and-paddingconcatenation-operations" id="toc-constants-and-paddingconcatenation-operations">Constants and
padding/concatenation operations</a></li>
<li><a href="#gradient" id="toc-gradient">Gradient</a></li>
<li><a href="#reductions" id="toc-reductions">Reductions</a></li>
</ul></li>
<li><a href="#advices-and-random-notes" id="toc-advices-and-random-notes">Advices and random notes</a>
<ul>
<li><a href="#aliases" id="toc-aliases">Aliases</a></li>
<li><a href="#type-checking" id="toc-type-checking">Type
checking</a></li>
</ul></li>
<li><a href="#the-intcst-type" id="toc-the-intcst-type">The
<code>IntCst</code> type</a></li>
<li><a href="#duplicate-items-in-expressions" id="toc-duplicate-items-in-expressions">Duplicate items in
expressions</a></li>
</ul>
</div>

<div id="setup" class="section level2">
<h2>Setup</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co"># load rkeops</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(rkeops)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="co"># create a dedicated Python environment with reticulate (to be done only once)</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>reticulate<span class="sc">::</span><span class="fu">virtualenv_create</span>(<span class="st">&quot;rkeops&quot;</span>)</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="co"># activate the dedicated Python environment</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>reticulate<span class="sc">::</span><span class="fu">use_virtualenv</span>(<span class="at">virtualenv =</span> <span class="st">&quot;rkeops&quot;</span>, <span class="at">required =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="co"># install rkeops requirements (to be done only once)</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="fu">install_rkeops</span>()</span></code></pre></div>
</div>
<div id="lazy-evaluation" class="section level2">
<h2>Lazy evaluation</h2>
<p>Lazy evaluation allows to write intermediate computations as symbolic
operations that are not directly evaluated. The real evaluation is only
made on final computation.</p>
<p>To do so, you can use <code>LazyTensors</code>. These are objects
wrapped around R matrices or vectors used to create symbolic formulas
for the <code>KeOps</code> reduction operations. A typical use case is
the following:</p>
<p>Let us say that we want to compute (for all <span class="math inline">\(j=1,\dots,N\)</span>):</p>
<p><span class="math display">\[
a_j = \sum_{i=1}^{M} \exp\left(-\frac{\Vert \mathbf x_i - \mathbf
y_j\Vert^2}{s^2}\right)
\]</span></p>
<p>with</p>
<ul>
<li><p>parameter: <span class="math inline">\(s \in\mathbb
R\)</span><br></p></li>
<li><p><span class="math inline">\(i\)</span>-indexed variables <span class="math inline">\(\mathbf X = [\mathbf x_i]_{i=1,...,M} \in\mathbb
R^{M\times 3}\)</span><br></p></li>
<li><p><span class="math inline">\(j\)</span>-indexed variables <span class="math inline">\(\mathbf Y = [\mathbf y_j]_{j=1,...,N} \in\mathbb
R^{N\times 3}\)</span><br><br></p></li>
</ul>
<p>The associated code would be:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># to run computation on CPU (default mode)</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="fu">rkeops_use_cpu</span>()</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="co"># OR</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="co"># to run computations on GPU (to be used only if relevant)</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="fu">rkeops_use_gpu</span>()</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="co"># Data</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>M <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">15000</span></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(N <span class="sc">*</span> <span class="dv">3</span>), <span class="at">nrow =</span> M, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="co"># arbitrary R matrix representing </span></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>                                              <span class="co"># 10000 data points in R^3</span></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(M <span class="sc">*</span> <span class="dv">3</span>), <span class="at">nrow =</span> N, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="co"># arbitrary R matrix representing </span></span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>                                              <span class="co"># 15000 data points in R^3</span></span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fl">0.1</span>                                      <span class="co"># scale parameter</span></span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a><span class="co"># Turn our Tensors into KeOps symbolic variables:</span></span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a>x_i <span class="ot">&lt;-</span> <span class="fu">LazyTensor</span>(x, <span class="st">&quot;i&quot;</span>)     <span class="co"># symbolic object representing an arbitrary row of x, </span></span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a>                              <span class="co"># indexed by the letter &quot;i&quot;</span></span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a>y_j <span class="ot">&lt;-</span> <span class="fu">LazyTensor</span>(y, <span class="st">&quot;j&quot;</span>)     <span class="co"># symbolic object representing an arbitrary row of y, </span></span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a>                              <span class="co"># indexed by the letter &quot;j&quot;</span></span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a><span class="co"># Perform large-scale computations, without memory overflows:</span></span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a>D_ij <span class="ot">&lt;-</span> <span class="fu">sum</span>((x_i <span class="sc">-</span> y_j)<span class="sc">^</span><span class="dv">2</span>)    <span class="co"># symbolic matrix of pairwise squared distances, </span></span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a>                              <span class="co"># with 10000 rows and 15000 columns</span></span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" tabindex="-1"></a>K_ij <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span> D_ij <span class="sc">/</span> s<span class="sc">^</span><span class="dv">2</span>)     <span class="co"># symbolic matrix, 10000 rows and 15000 columns</span></span>
<span id="cb2-27"><a href="#cb2-27" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" tabindex="-1"></a><span class="co"># D_ij and K_ij are only symbolic at that point, no computation is done</span></span>
<span id="cb2-29"><a href="#cb2-29" tabindex="-1"></a></span>
<span id="cb2-30"><a href="#cb2-30" tabindex="-1"></a><span class="co"># Computing the result without storing D_ij and K_ij:</span></span>
<span id="cb2-31"><a href="#cb2-31" tabindex="-1"></a>a_j <span class="ot">&lt;-</span> <span class="fu">sum</span>(K_ij, <span class="at">index =</span> <span class="st">&quot;i&quot;</span>) <span class="co"># actual R matrix (in fact a row vector of </span></span>
<span id="cb2-32"><a href="#cb2-32" tabindex="-1"></a>                              <span class="co"># length 15000 here)</span></span>
<span id="cb2-33"><a href="#cb2-33" tabindex="-1"></a>                              <span class="co"># containing the column sums of K_ij</span></span>
<span id="cb2-34"><a href="#cb2-34" tabindex="-1"></a>                              <span class="co"># (i.e. the sums over the &quot;i&quot; index, for each </span></span>
<span id="cb2-35"><a href="#cb2-35" tabindex="-1"></a>                              <span class="co"># &quot;j&quot; index)</span></span></code></pre></div>
<p>All the available operations are listed in the <a href="#operations">section “Operation”</a>.</p>
</div>
<div id="lazytensor" class="section level2">
<h2>LazyTensor</h2>
<p>To encode symbolically a matrix, a vector, or a single value as a
<code>LazyTensor</code>, you can use the function
<code>LazyTensor()</code>. Run <code>?LazyTensor</code> to display the
complete documentation.</p>
<p><strong>Note:</strong> In general, the term “<code>LazyTensor</code>”
can denote both a single matrix or vector wrapped in a
<code>LazyTensor</code> or several <code>LazyTensors</code> combined
with a formula; same for “<code>ComplexLazyTensor</code>”.</p>
<div id="complexlazytensor" class="section level3">
<h3>ComplexLazyTensor</h3>
<p>The <code>LazyTensor</code> function also allows to encode
mathematical objects formed of complex numbers. These new objects are
called <code>ComplexLazyTensors</code> but note that these are also
<code>LazyTensors</code>, however, they are not encoded quite the same
way: the real and complex parts are dissociated and stored in two
contiguous columns. Below is a simple example of what complex number
objects become once encoded as <code>ComplexLazyTensors</code>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># Arbitrary complex R matrix</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span><span class="dt">i</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">6</span><span class="sc">:-</span><span class="dv">1</span>), <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>z</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="do">##      [,1] [,2]</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="do">## [1,] 1+0i 3+0i</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="do">## [2,] 2-1i 2+1i</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="co"># Encode as a `ComplexLazyTensor`, indexed by &#39;i&#39;</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>z_i <span class="ot">&lt;-</span> <span class="fu">LazyTensor</span>(z, <span class="at">index =</span> <span class="st">&#39;i&#39;</span>, <span class="at">is_complex =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a><span class="co"># extract the data (corresponding to `z` value)</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>z_i<span class="sc">$</span>data</span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a><span class="do">## [[1]]</span></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a><span class="do">##      [,1] [,2] [,3] [,4]</span></span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a><span class="do">## [1,]    1    0    3    0</span></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a><span class="do">## [2,]    2   -1    2    1</span></span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a><span class="co"># Same idea with a vector of complex</span></span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a>v_z <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">4</span> <span class="sc">+</span> <span class="dv">5</span><span class="dt">i</span>, <span class="dv">2</span> <span class="sc">+</span> <span class="dv">3</span><span class="dt">i</span>, <span class="dv">7</span> <span class="sc">+</span> <span class="dv">1</span><span class="dt">i</span>)</span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a>v_z</span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a><span class="do">## [1] 4+5i 2+3i 7+1i</span></span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a><span class="co"># Encode as a vector parameter `ComplexLazyTensor`</span></span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a>Pm_v_z <span class="ot">&lt;-</span> <span class="fu">LazyTensor</span>(v_z, <span class="at">is_complex =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" tabindex="-1"></a><span class="co"># extract the data (corresponding to `v_z` value)</span></span>
<span id="cb3-27"><a href="#cb3-27" tabindex="-1"></a>Pm_v_z<span class="sc">$</span>data</span>
<span id="cb3-28"><a href="#cb3-28" tabindex="-1"></a><span class="do">## [[1]]</span></span>
<span id="cb3-29"><a href="#cb3-29" tabindex="-1"></a><span class="do">##     [,1] [,2] [,3] [,4] [,5] [,6]</span></span>
<span id="cb3-30"><a href="#cb3-30" tabindex="-1"></a><span class="do">## [1,]    4    5    2    3    7    1</span></span></code></pre></div>
<p>Of course if you create a vector or a matrix of real values, and
encode it as a <code>ComplexLazyTensor</code>, a zero imaginary part is
added to it:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># Real R vector</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>v <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">4</span>, <span class="dv">7</span>, <span class="dv">9</span>)</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>Pm_v <span class="ot">&lt;-</span> <span class="fu">LazyTensor</span>(v, <span class="at">is_complex =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>Pm_v<span class="sc">$</span>data</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="do">## [[1]]</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="do">##      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8]</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="do">## [1,]    5    0    4    0    7    0    9    0</span></span></code></pre></div>
</div>
</div>
<div id="operations" class="section level2">
<h2>Operations</h2>
<p><strong>Note:</strong> If none of the input arguments are of class
<code>LazyTensor</code> or <code>ComplexLazyTensor</code>, the default
<code>R</code> function (if any) is used instead. Please refer to the
help page of each function for type compatibility, dimension
compatibility, and further details. You can also take a look at the
“Using <code>RKeOps</code>” vignette, at the “Arguments” section, for
further explanations about inner and outer dimensions.</p>
<div id="result-dimension" class="section level3">
<h3>Result dimension</h3>
<p><code>LazyTensors</code> contain a <code>dimres</code> attribute,
which is an integer corresponding to the inner dimension of the
LazyTensor. It is used when creating new <code>LazyTensors</code>
resulting from operations to keep track of the dimension, and it enables
you to check dimension compatibility when dealing with large
operations.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="co"># arbitrary R matrices representing 100 data points in R^3</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(N <span class="sc">*</span> <span class="dv">3</span>), <span class="at">nrow =</span> N, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(N <span class="sc">*</span> <span class="dv">3</span>), <span class="at">nrow =</span> N, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(N <span class="sc">*</span> <span class="dv">3</span>), <span class="at">nrow =</span> N, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="co"># Create `LazyTensor`s from `w`, `x` and `y`</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>w_i <span class="ot">&lt;-</span> <span class="fu">LazyTensor</span>(w, <span class="st">&quot;i&quot;</span>)</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>x_i <span class="ot">&lt;-</span> <span class="fu">LazyTensor</span>(x, <span class="st">&quot;i&quot;</span>)</span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>y_j <span class="ot">&lt;-</span> <span class="fu">LazyTensor</span>(y, <span class="st">&quot;j&quot;</span>)</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a><span class="co"># print `x_i` inner dimension:</span></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>x_i<span class="sc">$</span>dimres</span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a><span class="co"># print `y_j` inner dimension:</span></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>y_j<span class="sc">$</span>dimres</span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a><span class="co"># Simple addition</span></span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>sum_xy <span class="ot">&lt;-</span> x_i <span class="sc">+</span> y_j</span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a><span class="co"># print `sum_xy` inner dimension:</span></span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a>sum_xy<span class="sc">$</span>dimres</span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a><span class="co"># Euclidean element-wise squared distance</span></span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a>sq_dist_sum_xy_w <span class="ot">&lt;-</span> <span class="fu">sqdist</span>(sum_xy, w_i)</span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a><span class="co"># print `sq_dist_sum_xy_w` inner dimension:</span></span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a>sq_dist_sum_xy_w<span class="sc">$</span>dimres</span></code></pre></div>
</div>
<div id="simple-arithmetics" class="section level3">
<h3>Simple arithmetics</h3>
<p>Here, <code>x</code> and <code>y</code> are <code>LazyTensors</code>,
and the result as well.</p>
<table>
<thead>
<tr class="header">
<th align="left">operation</th>
<th align="left">meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code>x + y</code></td>
<td align="left">element-wise addition of <code>x</code> and
<code>y</code></td>
</tr>
<tr class="even">
<td align="left"><code>x - y</code></td>
<td align="left">element-wise subtraction of <code>x</code> and
<code>y</code></td>
</tr>
<tr class="odd">
<td align="left"><code>-x</code></td>
<td align="left">element-wise opposite of <code>x</code></td>
</tr>
<tr class="even">
<td align="left"><code>x * y</code></td>
<td align="left">element-wise multiplication of <code>x</code> and
<code>y</code></td>
</tr>
<tr class="odd">
<td align="left"><code>x / y</code></td>
<td align="left">element-wise division of <code>x</code> by
<code>y</code></td>
</tr>
<tr class="even">
<td align="left"><code>x^y</code></td>
<td align="left">element-wise value of <code>x</code> to the power of
<code>y</code></td>
</tr>
<tr class="odd">
<td align="left"><code>(x|y)</code></td>
<td align="left">Euclidean scalar product between <code>x</code> and
<code>y</code></td>
</tr>
</tbody>
</table>
</div>
<div id="elementary-functions" class="section level3">
<h3>Elementary functions</h3>
<p>Here, <code>x</code> and <code>y</code> are <code>LazyTensors</code>,
and the result as well.</p>
<table>
<colgroup>
<col width="19%" />
<col width="80%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">function</th>
<th align="left">meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code>square(x)</code></td>
<td align="left">element-wise square of <code>x</code> (faster than
<code>x^2</code>)</td>
</tr>
<tr class="even">
<td align="left"><code>sqrt(x)</code></td>
<td align="left">element-wise square root of <code>x</code> (faster than
<code>x^(.5)</code>)</td>
</tr>
<tr class="odd">
<td align="left"><code>rsqrt(x)</code></td>
<td align="left">element-wise inverse square root of <code>x</code>
(faster than <code>x^(-.5)</code>)</td>
</tr>
<tr class="even">
<td align="left"><code>exp(x)</code></td>
<td align="left">element-wise exponential of <code>x</code></td>
</tr>
<tr class="odd">
<td align="left"><code>log(x)</code></td>
<td align="left">element-wise natural logarithm of <code>x</code></td>
</tr>
<tr class="even">
<td align="left"><code>xlogx(x)</code></td>
<td align="left">element-wise <code>x * log(x)</code> (with value
<code>0</code> at <code>0</code>)</td>
</tr>
<tr class="odd">
<td align="left"><code>inv(x)</code></td>
<td align="left">element-wise inverse of <code>x</code></td>
</tr>
<tr class="even">
<td align="left"><code>cos(x)</code></td>
<td align="left">element-wise cosine of <code>x</code></td>
</tr>
<tr class="odd">
<td align="left"><code>sin(x)</code></td>
<td align="left">element-wise sine of <code>x</code></td>
</tr>
<tr class="even">
<td align="left"><code>sinxdivx(x)</code></td>
<td align="left">element-wise <code>sin(x) / x</code> (with value
<code>1</code> at <code>0</code>)</td>
</tr>
<tr class="odd">
<td align="left"><code>acos(x)</code></td>
<td align="left">element-wise arc-cosine of <code>x</code></td>
</tr>
<tr class="even">
<td align="left"><code>asin(x)</code></td>
<td align="left">element-wise arc-sine of <code>x</code></td>
</tr>
<tr class="odd">
<td align="left"><code>acos(x)</code></td>
<td align="left">element-wise arc-cosine of <code>x</code></td>
</tr>
<tr class="even">
<td align="left"><code>atan(x)</code></td>
<td align="left">element-wise arc-tangent of <code>x</code></td>
</tr>
<tr class="odd">
<td align="left"><code>atan2(x, y)</code></td>
<td align="left">element-wise <a href="https://en.wikipedia.org/wiki/Atan2">2-argument arc-tangent
function</a></td>
</tr>
<tr class="even">
<td align="left"><code>abs(x)</code></td>
<td align="left">element-wise absolute value of <code>x</code> (or
modulus if <code>x</code> is a <code>ComplexLazyTensor</code>, same as
<code>Mod(x)</code>)</td>
</tr>
<tr class="odd">
<td align="left"><code>sign(x)</code></td>
<td align="left">element-wise sign of <code>x</code> (<code>-1</code> if
<code>x &lt; 0</code>, <code>0</code> if <code>x = 0</code>,
<code>+1</code> if <code>x &gt; 0</code>)</td>
</tr>
<tr class="even">
<td align="left"><code>step(x)</code></td>
<td align="left">element-wise step function (<code>0</code> if
<code>x &lt; 0</code>, <code>1</code> if <code>x &gt;= 0</code>)</td>
</tr>
<tr class="odd">
<td align="left"><code>relu(x)</code></td>
<td align="left">element-wise ReLU function (<code>0</code> if
<code>x &lt; 0</code>, <code>x</code> if <code>x &gt;= 0</code>)</td>
</tr>
<tr class="even">
<td align="left"><code>clamp(x, a, b)</code></td>
<td align="left">element-wise Clamp function (<code>a</code> if
<code>x &lt; a</code>, <code>x</code> if <code>a &lt;= x &lt;= b</code>,
<code>b</code> if <code>b &lt; x</code>)</td>
</tr>
<tr class="odd">
<td align="left"><code>clampint(x, a, b)</code></td>
<td align="left">element-wise Clamp function with <code>a</code> and
<code>b</code> fixed integers</td>
</tr>
<tr class="even">
<td align="left"><code>ifelse(x, a, b)</code></td>
<td align="left">element-wise If-Else function (<code>a</code> if
<code>x &gt;= 0</code>, <code>b</code> if <code>x &lt; 0</code>)</td>
</tr>
<tr class="odd">
<td align="left"><code>mod(x, a, b)</code></td>
<td align="left">element-wise Modulo function, with offset
(<code>x - a * floor((x - b)/a)</code>)</td>
</tr>
<tr class="even">
<td align="left"><code>round(x, d)</code></td>
<td align="left">element-wise rounding of <code>x</code> to
<code>d</code> decimal places</td>
</tr>
</tbody>
</table>
</div>
<div id="operations-involving-complex-numbers" class="section level3">
<h3>Operations involving complex numbers</h3>
<p>Here, <code>z</code> is a <code>ComplexLazyTensor</code>, and
<code>x</code> is a <code>LazyTensor</code>. The result is a
<code>LazyTensor</code> or a <code>ComplexLazyTensor</code>, depending
on the operation.</p>
<table>
<colgroup>
<col width="19%" />
<col width="80%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">operation</th>
<th align="left">meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code>Re(z)</code></td>
<td align="left">element-wise real part of <code>z</code></td>
</tr>
<tr class="even">
<td align="left"><code>Im(z)</code></td>
<td align="left">element-wise imaginary part of <code>z</code></td>
</tr>
<tr class="odd">
<td align="left"><code>Arg(z)</code></td>
<td align="left">element-wise angle (or argument) of <code>z</code></td>
</tr>
<tr class="even">
<td align="left"><code>Mod(z)</code></td>
<td align="left">element-wise modulus of <code>z</code></td>
</tr>
<tr class="odd">
<td align="left"><code>Conj(z)</code></td>
<td align="left">element-wise conjugate of <code>z</code></td>
</tr>
<tr class="even">
<td align="left"><code>real2complex(x)</code></td>
<td align="left">element-wise conversion of real to complex with zero
imaginary part (<code>x + 0i</code>)</td>
</tr>
<tr class="odd">
<td align="left"><code>imag2complex(x)</code></td>
<td align="left">element-wise conversion of real to complex with zero
real part (<code>0 + xi</code>)</td>
</tr>
</tbody>
</table>
</div>
<div id="simple-vector-operations" class="section level3">
<h3>Simple vector operations</h3>
<p>Here, <code>x</code>, <code>y</code> and <code>s</code> are
<code>LazyTensors</code>, and the result as well.</p>
<table>
<colgroup>
<col width="26%" />
<col width="73%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">operation</th>
<th align="left">meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code>norm2(x)</code></td>
<td align="left">L2 norm of <code>x</code>, same as
<code>sqrt(x|x)</code></td>
</tr>
<tr class="even">
<td align="left"><code>sqnorm2(x)</code></td>
<td align="left">squared L2 norm of <code>x</code>, same as
<code>(x|x)</code></td>
</tr>
<tr class="odd">
<td align="left"><code>normalize(x)</code></td>
<td align="left">normalization of <code>x</code>, same as
<code>rsqrt(sqnorm2(x)) * x</code></td>
</tr>
<tr class="even">
<td align="left"><code>sqdist(x, y)</code></td>
<td align="left">Euclidean distance between <code>x</code> and
<code>y</code>, same as <code>sqnorm2(x - y)</code></td>
</tr>
<tr class="odd">
<td align="left"><code>weightedsqnorm(x, s)</code></td>
<td align="left">generic weighted squared euclidean norm of
<code>x</code>, with weights stored in <code>s</code> (see details
below)</td>
</tr>
<tr class="even">
<td align="left"><code>weightedsqdist(x, y, s)</code></td>
<td align="left">generic weighted squared euclidean distance between
<code>x</code> and <code>y</code>, same as
<code>weightedsqnorm(x - y, s)</code></td>
</tr>
</tbody>
</table>
<p>Generic squared Euclidean norms support scalar weights, and diagonal
or full (symmetric) weight matrices. If <span class="math inline">\(x\)</span> is a vector of size <span class="math inline">\(n\)</span>, depending on the size of <span class="math inline">\(s\)</span>, <code>weightedsqnorm(x, s)</code> may
refer to:</p>
<ul>
<li>a weighted L2 norm <span class="math inline">\(s_0\displaystyle\sum_{i = 0}^{n - 1}
x_i^2\)</span> if <span class="math inline">\(s\)</span> is a vector of
size <span class="math inline">\(1\)</span>.</li>
<li>a separable norm <span class="math inline">\(\displaystyle\sum_{i =
0}^{n - 1} s_i x_i^2\)</span> if <span class="math inline">\(s\)</span>
is a vector of size <span class="math inline">\(n\)</span>.</li>
<li>a full anisotropic norm <span class="math inline">\(\displaystyle\sum_{i,j\ =\ 0}^{n - 1} s_{in + j}
x_i x_j\)</span> if <span class="math inline">\(s\)</span> is a vector
of size <span class="math inline">\(n^2\)</span> such that <span class="math inline">\(s_{in+j} = s_{jn+i}\)</span> (i.e. stores a
symmetric matrix).</li>
</ul>
</div>
<div id="elementary-dot-products" class="section level3">
<h3>Elementary dot products</h3>
<p>Here, <code>x</code> and <code>y</code> are <code>LazyTensors</code>,
and the result as well.</p>
<table>
<colgroup>
<col width="19%" />
<col width="80%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">operation</th>
<th align="left">meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code>matvecmult(x, y)</code></td>
<td align="left">matrix-vector product <code>x</code> <span class="math inline">\(\times\)</span> <code>y</code>: <code>x</code> is
a vector interpreted as matrix (column-major), <code>y</code> is a
vector</td>
</tr>
<tr class="even">
<td align="left"><code>vecmatmult(x, y)</code></td>
<td align="left">vector-matrix product <code>x</code> <span class="math inline">\(\times\)</span> <code>y</code>: <code>x</code> is
a vector, <code>y</code> is a vector interpreted as matrix
(column-major)</td>
</tr>
<tr class="odd">
<td align="left"><code>vecmatmult(x, y)</code></td>
<td align="left">vector-matrix product <code>x</code> <span class="math inline">\(\times\)</span> <code>y</code>: <code>x</code> is
a vector, <code>y</code> is a vector interpreted as matrix
(column-major)</td>
</tr>
<tr class="even">
<td align="left"><code>tensorprod(x, y)</code></td>
<td align="left">tensor product of vectors or matrices <code>x</code>
and <code>y</code></td>
</tr>
</tbody>
</table>
</div>
<div id="constants-and-paddingconcatenation-operations" class="section level3">
<h3>Constants and padding/concatenation operations</h3>
<p>Here, <code>x</code> and <code>y</code> are <code>LazyTensors</code>,
and <code>s</code> is a <code>LazyTensor</code> encoding a single value.
In each case, the output is a <code>LazyTensor</code>.</p>
<table>
<colgroup>
<col width="19%" />
<col width="80%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">operation</th>
<th align="left">meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code>sum(x)</code></td>
<td align="left">sum of the elements of <code>x</code></td>
</tr>
<tr class="even">
<td align="left"><code>max(x)</code></td>
<td align="left">max of the elements of <code>x</code></td>
</tr>
<tr class="odd">
<td align="left"><code>min(x)</code></td>
<td align="left">min of the elements of <code>x</code></td>
</tr>
<tr class="even">
<td align="left"><code>argmax(x)</code></td>
<td align="left">argmax of the elements of <code>x</code></td>
</tr>
<tr class="odd">
<td align="left"><code>argmin(x)</code></td>
<td align="left">argmin of the elements of <code>x</code></td>
</tr>
<tr class="even">
<td align="left"><code>elem(x, m)</code></td>
<td align="left">extract the <code>m</code>-th element
<code>x</code></td>
</tr>
<tr class="odd">
<td align="left"><code>elemT(s, m, n)</code></td>
<td align="left">insert <code>s</code> at position <code>m</code> in a
<code>LazyTensor</code> encoding a vector of zeros of dimension
<code>n</code></td>
</tr>
<tr class="even">
<td align="left"><code>extract(x, m, d)</code></td>
<td align="left">extract sub-vector or sub-matrix from <code>x</code>
(<code>m</code> is the starting index, <code>d</code> is the inner
dimension of the extracted sub-vector or sub-matrix)</td>
</tr>
<tr class="odd">
<td align="left"><code>extractT(x, m, d)</code></td>
<td align="left">insert <code>x</code> in a vector or a matrix of zeros,
at starting position <code>m</code> - output has an inner dimension
equal to <code>d</code></td>
</tr>
<tr class="even">
<td align="left"><code>concat(x, y)</code></td>
<td align="left">concatenation of <code>x</code> and <code>y</code></td>
</tr>
<tr class="odd">
<td align="left"><code>one_hot(x, d)</code></td>
<td align="left">encodes a (rounded) scalar value as a one-hot vector of
dimension <code>d</code></td>
</tr>
</tbody>
</table>
</div>
<div id="gradient" class="section level3">
<h3>Gradient</h3>
<p>Here, <code>x</code> and <code>gradin</code> are
<code>LazyTensors</code>.</p>
<table>
<colgroup>
<col width="33%" />
<col width="66%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">operation</th>
<th align="left">meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code>grad(x, gradin, red, var, &quot;i&quot;)</code></td>
<td align="left">gradient of <code>x</code> with respect to the variable
<code>var</code> and applied to <code>gradin</code> with compiling the
corresponding reduction operator of <code>opstr</code></td>
</tr>
</tbody>
</table>
</div>
<div id="reductions" class="section level3">
<h3>Reductions</h3>
<p>Here, <code>f</code> is a combination of <code>LazyTensors</code>,
indexed by <code>i</code> and <code>j</code>, and <code>w</code> is a
<code>LazyTensor</code>.</p>
<p>The operations <code>sum()</code>, <code>min()</code>,
<code>argmin()</code>, <code>max()</code> and <code>argmax()</code> can
be called with <code>NA</code> index (default), in which case no
reduction is done and the result is a <code>LazyTensor</code> (see <a href="#simple-arithmetics">Simple arithmetics</a> and <a href="#elementary-functions">Elementary functions</a>). Otherwise, the
result is not a <code>LazyTensor</code> but an R array.</p>
<table>
<colgroup>
<col width="32%" />
<col width="33%" />
<col width="34%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">operation</th>
<th align="left">meaning</th>
<th align="left">mathematical expression</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code>sum(f, &quot;j&quot;)</code> <br>
<code>sum_reduction(f, &quot;j&quot;)</code></td>
<td align="left">sum reduction indexed by <code>j</code> of the elements
of <code>f</code></td>
<td align="left"><span class="math inline">\(\sum_j f_{ij}\)</span></td>
</tr>
<tr class="even">
<td align="left"><code>min(f, &quot;j&quot;)</code> <br>
<code>min_reduction(f, &quot;j&quot;)</code></td>
<td align="left">min reduction indexed by <code>j</code> of the elements
of <code>f</code></td>
<td align="left"><span class="math inline">\(\min_j f_{ij}\)</span></td>
</tr>
<tr class="odd">
<td align="left"><code>argmin(f, &quot;j&quot;)</code> <br>
<code>argmin_reduction(f, &quot;j&quot;)</code></td>
<td align="left">argmin reduction indexed by <code>j</code> of the
elements of <code>f</code></td>
<td align="left"><span class="math inline">\(\text{argmin}_j
f_{ij}\)</span></td>
</tr>
<tr class="even">
<td align="left"><code>min_argmin(f, &quot;j&quot;)</code> <br>
<code>min_argmin_reduction(f, &quot;j&quot;)</code></td>
<td align="left">min-argmin reduction indexed by <code>j</code> of the
elements of <code>f</code></td>
<td align="left"><span class="math inline">\(\left(\min_j f_{ij}
,\text{argmin}_j f_{ij}\right)\)</span></td>
</tr>
<tr class="odd">
<td align="left"><code>max(f, &quot;j&quot;)</code> <br>
<code>max_reduction(f, &quot;j&quot;)</code></td>
<td align="left">max reduction indexed by <code>j</code> of the elements
of <code>f</code></td>
<td align="left"><span class="math inline">\(\min_j f_{ij}\)</span></td>
</tr>
<tr class="even">
<td align="left"><code>argmax(f, &quot;j&quot;)</code> <br>
<code>argmax_reduction(f, &quot;j&quot;)</code></td>
<td align="left">argmax reduction indexed by <code>j</code> of the
elements of <code>f</code></td>
<td align="left"><span class="math inline">\(\text{argmin}_j
f_{ij}\)</span></td>
</tr>
<tr class="odd">
<td align="left"><code>max_argmax(f, &quot;j&quot;)</code> <br>
<code>max_argmax_reduction(f, &quot;j&quot;)</code></td>
<td align="left">max-argmax reduction indexed by <code>j</code> of the
elements of <code>f</code></td>
<td align="left"><span class="math inline">\(\left(\max_j f_{ij}
,\text{argmax}_j f_{ij}\right)\)</span></td>
</tr>
<tr class="even">
<td align="left"><code>logsumexp(f, &quot;j&quot;, w)</code> <br>
<code>logsumexp_reduction(f, &quot;j&quot;, w)</code></td>
<td align="left"><a href="https://en.wikipedia.org/wiki/LogSumExp">LogSumExp reduction</a>,
indexed by <code>j</code> of the elements of <code>f</code>, with weight
stored in <code>w</code></td>
<td align="left"><span class="math inline">\(\log\left(\sum_j\exp(f_{ij})\right)\)</span></td>
</tr>
<tr class="odd">
<td align="left"><code>sumsoftmaxweight(f, &quot;j&quot;, w)</code> <br>
<code>sumsoftmaxweight_reduction(f, &quot;j&quot;, w)</code></td>
<td align="left">“Sum of weighted Soft-Max” reduction indexed by
<code>j</code> of the elements of <code>f</code></td>
<td align="left"><span class="math inline">\(\left(\sum_j\exp(f_{ij})w_{ij}\right)/\left(\sum_j\exp(f_{ij})\right)\)</span></td>
</tr>
</tbody>
</table>
<div id="special-reduction" class="section level4">
<h4>Special reduction</h4>
<p>Here, <code>x</code> is a <code>LazyTensor</code> of inner dimension
<span class="math inline">\(D\)</span> and outer dimension <span class="math inline">\(M\)</span>, indexed by <span class="math inline">\(i \in \{1, \ldots ,M\}\)</span>, and
<code>y</code> is a <code>LazyTensor</code> of inner dimension <span class="math inline">\(D\)</span> and outer dimension <span class="math inline">\(N\)</span>, indexed by <span class="math inline">\(j \in \{1, \ldots ,N\}\)</span>.</p>
<table>
<colgroup>
<col width="6%" />
<col width="62%" />
<col width="30%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">operation</th>
<th align="left">meaning</th>
<th align="left">mathematical expression</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code>x %*% y</code></td>
<td align="left">sum reduction of the product <code>x</code> *
<code>y</code> indexed by <code>j</code>.<br> Same as
<code>sum_reduction(x * y, &quot;j&quot;)</code></td>
<td align="left"><span class="math inline">\(\sum_j x_{ik} y_{jk}, ~ k
\in \{1, \ldots, N\}\)</span></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="advices-and-random-notes" class="section level2">
<h2>Advices and random notes</h2>
<div id="aliases" class="section level3">
<h3>Aliases</h3>
<p>You can use <code>Vi</code>, <code>Vj</code> and <code>Pm</code>
aliases to create <code>LazyTensors</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># Data</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(N <span class="sc">*</span> <span class="dv">3</span>), <span class="at">nrow =</span> N, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="co"># arbitrary R matrix representing </span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>                                              <span class="co"># 100 data points in R^3</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>v <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">3</span>, <span class="dv">0</span>, <span class="dv">1</span>)                           <span class="co"># arbitrary vector of length 3</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fl">0.1</span>                                      <span class="co"># scale parameter</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="co"># Create symbolic object representing an arbitrary row of x, </span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="co"># indexed by the letter &quot;i&quot;:</span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>x_i <span class="ot">&lt;-</span> <span class="fu">LazyTensor</span>(x, <span class="st">&quot;i&quot;</span>)   </span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a><span class="co"># Same as</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>x_i <span class="ot">&lt;-</span> <span class="fu">Vi</span>(x)</span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a><span class="co"># Create symbolic object representing an arbitrary row of x, </span></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a><span class="co"># indexed by the letter &quot;j&quot;:</span></span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a>x_j <span class="ot">&lt;-</span> <span class="fu">LazyTensor</span>(x, <span class="st">&quot;j&quot;</span>)</span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a><span class="co"># Same as</span></span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>x_j <span class="ot">&lt;-</span> <span class="fu">Vj</span>(x)</span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a><span class="co"># Create symbolic object representing the vector `v` above:</span></span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a>LT_v <span class="ot">&lt;-</span> <span class="fu">LazyTensor</span>(v)</span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a><span class="co"># Same as</span></span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a>LT_v <span class="ot">&lt;-</span> <span class="fu">Pm</span>(v)</span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a><span class="co"># Create symbolic object representing the scalar `s` above:</span></span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a>LT_s <span class="ot">&lt;-</span> <span class="fu">LazyTensor</span>(s)</span>
<span id="cb6-27"><a href="#cb6-27" tabindex="-1"></a><span class="co"># Same as</span></span>
<span id="cb6-28"><a href="#cb6-28" tabindex="-1"></a>LT_s <span class="ot">&lt;-</span> <span class="fu">Pm</span>(s)</span></code></pre></div>
</div>
<div id="type-checking" class="section level3">
<h3>Type checking</h3>
<p>You can check the “type” of your “object” and/or what kind of values
it encodes.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>D <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>M <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(M <span class="sc">*</span> D), M, D)   <span class="co"># matrix of real values</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>x_i <span class="ot">&lt;-</span> <span class="fu">LazyTensor</span>(x, <span class="at">index =</span> <span class="st">&#39;i&#39;</span>)</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">LazyTensor</span>(<span class="fu">runif</span>(<span class="dv">3</span>, <span class="dv">0</span>, <span class="dv">1</span>))   <span class="co"># LazyTensor encoding a fixed vector of real values</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>l <span class="ot">&lt;-</span> <span class="fu">LazyTensor</span>(<span class="dv">314</span>)              <span class="co"># LazyTensor encoding a fixed scalar parameter</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="dt">i</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">6</span><span class="sc">:</span><span class="dv">5</span>), <span class="at">nrow =</span> <span class="dv">4</span>)  <span class="co"># matrix of complex values</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>z_i <span class="ot">&lt;-</span> <span class="fu">LazyTensor</span>(z, <span class="at">index =</span> <span class="st">&#39;i&#39;</span>, <span class="at">is_complex =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>scal <span class="ot">&lt;-</span> <span class="fl">3.14</span></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>cplx <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">+</span> <span class="dv">3</span><span class="dt">i</span></span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>scal_LT <span class="ot">&lt;-</span> <span class="fu">LazyTensor</span>(scal)</span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>cplx_LT <span class="ot">&lt;-</span> <span class="fu">LazyTensor</span>(cplx)</span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a><span class="co"># check types</span></span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a><span class="fu">is.LazyTensor</span>(x_i)</span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a><span class="fu">is.ComplexLazyTensor</span>(z_i)</span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a><span class="fu">is.LazyVector</span>(p)</span>
<span id="cb7-21"><a href="#cb7-21" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" tabindex="-1"></a><span class="fu">is.LazyParameter</span>(scal_LT)</span>
<span id="cb7-23"><a href="#cb7-23" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" tabindex="-1"></a><span class="fu">is.ComplexLazyParameter</span>(cplx_LT)</span></code></pre></div>
<p>Note that the examples above are rudimentary, but this can become
very handy when dealing with more complex expressions.</p>
</div>
</div>
<div id="the-intcst-type" class="section level2">
<h2>The <code>IntCst</code> type</h2>
<p>When a single integer value <code>n</code> is encoded as a
<code>LazyTensor</code>, its formula is simply <code>&quot;IntCst(n)&quot;</code>,
which contains all the necessary information, and the <code>args</code>
and <code>data</code> attributes remain empty to avoid useless
storage.</p>
</div>
<div id="duplicate-items-in-expressions" class="section level2">
<h2>Duplicate items in expressions</h2>
<p>When the same <code>LazyTensor</code> variable, indexed the same way,
is used several times in an expression, it will only appear once in the
<code>args</code> and <code>data</code> attributes to avoid useless
storage. Of course all its instances remain in the <code>formula</code>
attribute.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
